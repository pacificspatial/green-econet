name: Backend CI/CD -> EC2 (Staging)

# Trigger workflow only on changes to backend
on:
  push:
    branches:
      - aws-infrastructure-1
    paths:
      - 'server/**'
  workflow_dispatch: {}  # optional manual trigger

permissions:
  id-token: write
  contents: read

env:
  DEFAULT_AWS_REGION: ap-northeast-1
  SERVER_DIR: server
  EC2_INSTANCE_ID: ${{ secrets.STG_EC2_INSTANCE_ID }}

jobs:
  deploy-backend:
    name: Deploy Backend to EC2
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v4

      # 2️⃣ Configure AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.DEFAULT_AWS_REGION }}

      # 3️⃣ Deploy to EC2 via SSM
      - name: Deploy backend to EC2 via SSM
        run: |
          echo "Deploying backend to EC2 instance ${EC2_INSTANCE_ID}..."
          aws ssm send-command \
            --targets "Key=instanceIds,Values=${EC2_INSTANCE_ID}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy backend" \
            --parameters 'commands=[
              "cd /var/www/stg/",
              "npm install --production",
              "pm2 restart stg-enp"
            ]' \
            --region ${{ env.DEFAULT_AWS_REGION }}

      - name: Deployment completed
        run: echo "Backend deployment finished successfully!"
